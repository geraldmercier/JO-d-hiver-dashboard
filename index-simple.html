<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JO d'Hiver - Connexion</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="login-page">
        <div class="neige-particule"></div>
        <div class="neige-particule"></div>
        <div class="neige-particule"></div>
        <div class="neige-particule"></div>
        <div class="neige-particule"></div>

        <div class="login-carte">
            <div class="login-header">
                <span class="login-icone">ğŸ”ï¸</span>
                <h1 class="login-titre">JO d'Hiver 2026</h1>
                <p class="login-sous-titre">Challenge Commercial</p>
            </div>

            <div class="login-separateur"></div>

            <!-- FORMULAIRE UNIQUE -->
            <div id="zone-connexion">
                <h3 style="text-align: center; margin-bottom: 20px; color: var(--bleu-sombre);">Connexion</h3>
                
                <div class="groupe-champ">
                    <label>ğŸ“§ Email</label>
                    <input type="email" id="email-input" placeholder="prenom.nom@papernest.com" autocomplete="email">
                </div>

                <div class="groupe-champ">
                    <label>ğŸ”’ Mot de passe</label>
                    <input type="password" id="password-input" placeholder="Votre mot de passe" autocomplete="current-password">
                </div>

                <button class="btn-connexion" id="btn-login" onclick="connexion()">
                    Se Connecter â†’
                </button>

                <div style="text-align: center; margin-top: 16px;">
                    <a href="#" onclick="afficherInscription(); return false;" style="color: var(--bleu-sombre); text-decoration: none; font-size: 14px;">
                        PremiÃ¨re connexion ? CrÃ©er un compte
                    </a>
                </div>

                <div class="message-erreur" id="erreur-login"></div>
            </div>

            <!-- FORMULAIRE INSCRIPTION -->
            <div id="zone-inscription" style="display: none;">
                <h3 style="text-align: center; margin-bottom: 20px; color: var(--bleu-sombre);">CrÃ©er mon compte</h3>
                
                <div class="groupe-champ">
                    <label>ğŸ“§ Email</label>
                    <input type="email" id="email-signup" placeholder="prenom.nom@papernest.com" autocomplete="email">
                </div>

                <div class="groupe-champ">
                    <label>ğŸ”’ Mot de passe</label>
                    <input type="password" id="password-signup" placeholder="Minimum 8 caractÃ¨res" minlength="8">
                </div>

                <div class="groupe-champ">
                    <label>ğŸ”’ Confirmer</label>
                    <input type="password" id="password-confirm" placeholder="Retapez le mot de passe" minlength="8">
                </div>

                <button class="btn-connexion" id="btn-signup" onclick="inscription()">
                    CrÃ©er mon compte
                </button>

                <div style="text-align: center; margin-top: 16px;">
                    <a href="#" onclick="afficherConnexion(); return false;" style="color: var(--bleu-sombre); text-decoration: none; font-size: 14px;">
                        â† Retour Ã  la connexion
                    </a>
                </div>

                <div class="message-erreur" id="erreur-signup"></div>
            </div>

            <div class="login-equipes">
                ğŸ‡³ğŸ‡´ ğŸ‡«ğŸ‡· ğŸ‡¨ğŸ‡¦ ğŸ‡¦ğŸ‡¹ ğŸ‡ºğŸ‡¸
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.KEY);

        function afficherInscription() {
            document.getElementById('zone-connexion').style.display = 'none';
            document.getElementById('zone-inscription').style.display = 'block';
        }

        function afficherConnexion() {
            document.getElementById('zone-connexion').style.display = 'block';
            document.getElementById('zone-inscription').style.display = 'none';
        }

        async function connexion() {
            const email = document.getElementById('email-input').value.trim();
            const password = document.getElementById('password-input').value;

            if (!email || !password) {
                afficherErreur('erreur-login', 'Remplissez tous les champs');
                return;
            }

            if (!email.endsWith('@papernest.com')) {
                afficherErreur('erreur-login', 'Email doit finir par @papernest.com');
                return;
            }

            const btn = document.getElementById('btn-login');
            btn.textContent = 'Connexion...';
            btn.disabled = true;

            try {
                const result = await supabase.auth.signInWithPassword({ email, password });

                if (result.error) {
                    afficherErreur('erreur-login', 'Email ou mot de passe incorrect');
                    btn.textContent = 'Se Connecter â†’';
                    btn.disabled = false;
                    return;
                }

                const user = await supabase.from('users').select('*').eq('id', result.data.user.id).single();

                if (!user.data || !user.data.onboarding_complete) {
                    window.location.href = 'onboarding.html';
                } else if (user.data.role === 'manager' || user.data.role === 'admin') {
                    window.location.href = 'manager.html';
                } else {
                    window.location.href = 'dashboard.html';
                }

            } catch (error) {
                afficherErreur('erreur-login', error.message);
                btn.textContent = 'Se Connecter â†’';
                btn.disabled = false;
            }
        }

        async function inscription() {
            const email = document.getElementById('email-signup').value.trim();
            const password = document.getElementById('password-signup').value;
            const confirm = document.getElementById('password-confirm').value;

            if (!email || !password || !confirm) {
                afficherErreur('erreur-signup', 'Remplissez tous les champs');
                return;
            }

            if (!email.endsWith('@papernest.com')) {
                afficherErreur('erreur-signup', 'Email doit finir par @papernest.com');
                return;
            }

            if (password.length < 8) {
                afficherErreur('erreur-signup', 'Mot de passe minimum 8 caractÃ¨res');
                return;
            }

            if (password !== confirm) {
                afficherErreur('erreur-signup', 'Les mots de passe ne correspondent pas');
                return;
            }

            const btn = document.getElementById('btn-signup');
            btn.textContent = 'CrÃ©ation...';
            btn.disabled = true;

            try {
                const authResult = await supabase.auth.signUp({ email, password });

                if (authResult.error) {
                    afficherErreur('erreur-signup', authResult.error.message);
                    btn.textContent = 'CrÃ©er mon compte';
                    btn.disabled = false;
                    return;
                }

                const parts = email.split('@')[0].split('.');
                const prenom = parts[0] ? parts[0].charAt(0).toUpperCase() + parts[0].slice(1) : '';
                const nom = parts[1] ? parts[1].toUpperCase() : '';

                await supabase.from('users').insert({
                    id: authResult.data.user.id,
                    email: email,
                    prenom: prenom,
                    nom: nom,
                    role: 'agent',
                    onboarding_complete: false
                });

                window.location.href = 'onboarding.html';

            } catch (error) {
                afficherErreur('erreur-signup', error.message);
                btn.textContent = 'CrÃ©er mon compte';
                btn.disabled = false;
            }
        }

        function afficherErreur(id, texte) {
            const elem = document.getElementById(id);
            elem.textContent = texte;
            elem.classList.add('visible');
        }

        // Enter pour soumettre
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('zone-connexion').style.display !== 'none') {
                    connexion();
                } else {
                    inscription();
                }
            }
        });
    </script>
</body>
</html>
