<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèîÔ∏è Configuration du profil</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="onboarding.css">
</head>
<body class="onboarding-body">
    <div class="neige-particule"></div>
    <div class="neige-particule"></div>
    <div class="neige-particule"></div>
    <div class="neige-particule"></div>
    <div class="neige-particule"></div>

    <div class="onboarding-container">
        <!-- Indicateur de progression -->
        <div class="progress-steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Bienvenue</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Avatar</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">Manager</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">Cellule</div>
            </div>
        </div>

        <!-- √âTAPE 1 : Bienvenue -->
        <div class="etape active" id="etape-1">
            <div class="etape-icone">üèîÔ∏è</div>
            <h2>Bienvenue au Challenge JO d'Hiver 2026 !</h2>
            <p>Bonjour <strong>Agent</strong> ! üëã</p>
            <p>Avant de commencer le challenge, configurons votre profil en quelques √©tapes simples.</p>
            <p>Cela ne prendra que 2 minutes !</p>
            <button class="btn-continuer" onclick="allerEtape(2)">Commencer ‚Üí</button>
        </div>

        <!-- √âTAPE 2 : Avatar -->
        <div class="etape" id="etape-2">
            <h2>Choisissez votre avatar</h2>
            <p>S√©lectionnez l'avatar qui vous repr√©sentera durant le challenge</p>
            <div class="avatars-grid" id="avatars-grid"></div>
            <div class="etape-actions">
                <button class="btn-retour" onclick="allerEtape(1)">‚Üê Retour</button>
                <button class="btn-continuer" onclick="validerAvatar()">Continuer ‚Üí</button>
            </div>
            <div class="message-erreur" id="erreur-avatar"></div>
        </div>

        <!-- √âTAPE 3 : Manager -->
        <div class="etape" id="etape-3">
            <h2>Choisissez votre manager</h2>
            <p>S√©lectionnez le manager de votre √©quipe</p>
            <select id="select-manager" class="select-manager">
                <option value="">-- Chargement... --</option>
            </select>
            <div id="info-equipe" style="display: none; margin-top: 20px; padding: 16px; background: #E3F2FD; border-radius: 8px;">
                <p style="margin: 0; color: #1565C0;">
                    <strong>√âquipe affect√©e :</strong> 
                    <span id="drapeau-equipe-affectee"></span> 
                    <span id="nom-equipe-affectee"></span>
                </p>
            </div>
            <div class="etape-actions">
                <button class="btn-retour" onclick="allerEtape(2)">‚Üê Retour</button>
                <button class="btn-continuer" onclick="validerManager()">Continuer ‚Üí</button>
            </div>
            <div class="message-erreur" id="erreur-manager"></div>
        </div>

        <!-- √âTAPE 4 : Cellule -->
        <div class="etape" id="etape-4">
            <h2>Choisissez votre cellule</h2>
            <p>S√©lectionnez la cellule dans laquelle vous travaillez</p>
            <div class="cellules-grid">
                <div class="cellule-carte" onclick="selectionnerCellule('Mover')">
                    <div class="cellule-icone">üöö</div>
                    <div class="cellule-nom">Mover</div>
                </div>
                <div class="cellule-carte" onclick="selectionnerCellule('Switcher')">
                    <div class="cellule-icone">üîÑ</div>
                    <div class="cellule-nom">Switcher</div>
                </div>
                <div class="cellule-carte" onclick="selectionnerCellule('Coach')">
                    <div class="cellule-icone">üìû</div>
                    <div class="cellule-nom">Coach</div>
                </div>
                <div class="cellule-carte" onclick="selectionnerCellule('P√©pini√®re')">
                    <div class="cellule-icone">üå±</div>
                    <div class="cellule-nom">P√©pini√®re</div>
                </div>
            </div>
            <div class="etape-actions">
                <button class="btn-retour" onclick="allerEtape(3)">‚Üê Retour</button>
                <button class="btn-continuer" id="btn-terminer" onclick="terminerOnboarding()">‚úÖ Terminer</button>
            </div>
            <div class="message-erreur" id="erreur-cellule"></div>
        </div>

        <div class="onboarding-footer">
            <p>Challenge Commercial JO d'Hiver 2026 ‚õ∑Ô∏è</p>
        </div>
    </div>

    <script>
        const SUPABASE_CONFIG = {
            URL: "https://zmzwuutqyxgwjcbifpfq.supabase.co",
            KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inptend1dXRxeXhnd2pjYmlmcGZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NDI0OTAsImV4cCI6MjA4NTQxODQ5MH0.yJvJf71P3frQhhTgmKx5vLCz6NGP-_YQfQuyU-G8E3M"
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const sb = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.KEY);
        
        const selection = {
            avatarUrl: null,
            managerId: null,
            equipeId: null,
            cellule: null
        };

        const AVATARS = [
            'chicken.png', 'woman.png', 'lion.png', 'man (1).png', 'man (2).png',
            'man (3).png', 'man (4).png', 'man (5).png', 'man.png', 'panda.png',
            'parrot.png', 'sea-lion.png', 'tiger.png', 'woman (1).png', 'woman (2).png'
        ];

        let userId = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            const result = await sb.auth.getUser();
            if (!result.data.user) {
                window.location.href = 'connexion-finale.html';
                return;
            }
            userId = result.data.user.id;
            
            chargerAvatars();
            await chargerManagers();
        });

        function chargerAvatars() {
            const grid = document.getElementById('avatars-grid');
            grid.innerHTML = '';
            
            AVATARS.forEach(filename => {
                const div = document.createElement('div');
                div.className = 'avatar-option';
                div.innerHTML = `<img src="assets/${filename}" alt="Avatar">`;
                div.onclick = function() {
                    document.querySelectorAll('.avatar-option').forEach(d => d.classList.remove('selected'));
                    div.classList.add('selected');
                    selection.avatarUrl = `assets/${filename}`;
                    document.getElementById('erreur-avatar').style.display = 'none';
                };
                grid.appendChild(div);
            });
        }

        async function chargerManagers() {
            const select = document.getElementById('select-manager');
            
            try {
                const result = await sb
                    .from('users')
                    .select('id, nom, prenom, equipe_id, equipes(nom, drapeau)')
                    .eq('role', 'manager')
                    .order('nom');

                if (result.error) throw result.error;

                select.innerHTML = '<option value="">-- Choisissez votre manager --</option>';
                
                result.data.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = `${m.prenom} ${m.nom} (√âquipe ${m.equipes.nom} ${m.equipes.drapeau})`;
                    opt.dataset.equipeId = m.equipe_id;
                    opt.dataset.equipeNom = m.equipes.nom;
                    opt.dataset.equipeDrapeau = m.equipes.drapeau;
                    select.appendChild(opt);
                });

                select.onchange = function() {
                    const opt = this.options[this.selectedIndex];
                    if (opt.value) {
                        selection.managerId = opt.value;
                        selection.equipeId = opt.dataset.equipeId;
                        document.getElementById('nom-equipe-affectee').textContent = opt.dataset.equipeNom;
                        document.getElementById('drapeau-equipe-affectee').textContent = opt.dataset.equipeDrapeau;
                        document.getElementById('info-equipe').style.display = 'block';
                        document.getElementById('erreur-manager').style.display = 'none';
                    }
                };
            } catch (error) {
                console.error('Erreur managers:', error);
                select.innerHTML = '<option value="">Erreur de chargement</option>';
            }
        }

        function allerEtape(num) {
            document.querySelectorAll('.etape').forEach(e => e.classList.remove('active'));
            document.getElementById('etape-' + num).classList.add('active');
            
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.toggle('completed', i < num - 1);
                s.classList.toggle('active', i + 1 === num);
            });
        }

        function validerAvatar() {
            if (!selection.avatarUrl) {
                const err = document.getElementById('erreur-avatar');
                err.textContent = '‚ö†Ô∏è Choisissez un avatar';
                err.style.display = 'block';
                return;
            }
            allerEtape(3);
        }

        function validerManager() {
            if (!selection.managerId) {
                const err = document.getElementById('erreur-manager');
                err.textContent = '‚ö†Ô∏è Choisissez un manager';
                err.style.display = 'block';
                return;
            }
            allerEtape(4);
        }

        function selectionnerCellule(nom) {
            document.querySelectorAll('.cellule-carte').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            selection.cellule = nom;
            document.getElementById('erreur-cellule').style.display = 'none';
        }

        async function terminerOnboarding() {
            if (!selection.cellule) {
                const err = document.getElementById('erreur-cellule');
                err.textContent = '‚ö†Ô∏è Choisissez une cellule';
                err.style.display = 'block';
                return;
            }

            const btn = document.getElementById('btn-terminer');
            btn.textContent = '‚è≥ Enregistrement...';
            btn.disabled = true;

            try {
                await sb.from('users').update({
                    avatar_url: selection.avatarUrl,
                    manager_id: selection.managerId,
                    equipe_id: selection.equipeId,
                    cellule: selection.cellule,
                    onboarding_complete: true
                }).eq('id', userId);

                alert('‚úÖ Bienvenue !');
                window.location.href = 'dashboard.html';
            } catch (error) {
                alert('‚ùå Erreur : ' + error.message);
                btn.textContent = '‚úÖ Terminer';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
