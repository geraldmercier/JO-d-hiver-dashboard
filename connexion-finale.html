<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéø JO d'Hiver ‚Äî Connexion</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1565C0 0%, #1976D2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .neige-particule {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            opacity: 0.7;
            animation: neige 10s linear infinite;
        }
        .neige-particule:nth-child(1) { left: 10%; animation-delay: 0s; }
        .neige-particule:nth-child(2) { left: 30%; animation-delay: 2s; }
        .neige-particule:nth-child(3) { left: 50%; animation-delay: 4s; }
        .neige-particule:nth-child(4) { left: 70%; animation-delay: 1s; }
        .neige-particule:nth-child(5) { left: 90%; animation-delay: 3s; }
        @keyframes neige { 0% { top: -10%; } 100% { top: 110%; } }
        
        .login-carte {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 420px;
            z-index: 10;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-icone {
            font-size: 48px;
            display: block;
            margin-bottom: 16px;
        }
        .login-titre {
            color: #1565C0;
            font-size: 28px;
            margin-bottom: 8px;
        }
        .login-sous-titre {
            color: #757575;
            font-size: 14px;
        }
        .login-separateur {
            height: 2px;
            background: linear-gradient(to right, transparent, #E0E0E0, transparent);
            margin-bottom: 30px;
        }
        .groupe-champ {
            margin-bottom: 20px;
        }
        .groupe-champ label {
            display: block;
            color: #424242;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .groupe-champ input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E0E0E0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
        }
        .groupe-champ input:focus {
            outline: none;
            border-color: #1976D2;
        }
        .btn-connexion {
            width: 100%;
            padding: 14px;
            background: #1976D2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-connexion:hover {
            background: #1565C0;
        }
        .btn-connexion:disabled {
            background: #BDBDBD;
            cursor: not-allowed;
        }
        .message-erreur {
            background: #FFEBEE;
            color: #C62828;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
            font-size: 14px;
        }
        .message-erreur.visible {
            display: block;
        }
        .login-equipes {
            text-align: center;
            margin-top: 24px;
            font-size: 24px;
            letter-spacing: 8px;
        }
        .lien-switch {
            text-align: center;
            margin-top: 16px;
        }
        .lien-switch a {
            color: #1976D2;
            text-decoration: none;
            font-size: 14px;
        }
        .lien-switch a:hover {
            text-decoration: underline;
        }
        h3 {
            text-align: center;
            color: #1565C0;
            margin-bottom: 24px;
        }
        /* Ajout pour l'alignement Pr√©nom/Nom */
        .ligne-double {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="neige-particule"></div>
    <div class="neige-particule"></div>
    <div class="neige-particule"></div>
    <div class="neige-particule"></div>
    <div class="neige-particule"></div>

    <div class="login-carte">
        <div class="login-header">
            <img src="assets/olympic.png" alt="Logo" style="height: 80px; margin-bottom: 20px;">
            <h1 class="login-titre">JO d'Hiver 2026</h1>
            <p class="login-sous-titre">Challenge Commercial ‚Äî Call Center</p>
        </div>

        <div class="login-separateur"></div>

        <div id="zone-connexion">
            <h3>Connexion</h3>
            
            <div class="groupe-champ">
                <label>üìß Email</label>
                <input type="email" id="email-login" placeholder="prenom.nom@papernest.com">
            </div>

            <div class="groupe-champ">
                <label>üîí Mot de passe</label>
                <input type="password" id="pass-login" placeholder="Votre mot de passe">
            </div>

            <button class="btn-connexion" id="btn-login" onclick="connexion()">
                Se Connecter ‚Üí
            </button>

            <div class="lien-switch">
                <a href="#" onclick="afficherInscription(); return false;">Premi√®re connexion ? Cr√©er un compte</a>
            </div>

            <div class="message-erreur" id="erreur-login"></div>
        </div>

        <div id="zone-inscription" style="display: none;">
            <h3>Cr√©er mon compte</h3>
            
            <div class="ligne-double">
                <div class="groupe-champ">
                    <label>üë§ Pr√©nom</label>
                    <input type="text" id="prenom-signup" placeholder="Ex: Thomas">
                </div>
                <div class="groupe-champ">
                    <label>üë§ Nom</label>
                    <input type="text" id="nom-signup" placeholder="Ex: Durand">
                </div>
            </div>

            <div class="groupe-champ">
                <label>üìß Email</label>
                <input type="email" id="email-signup" placeholder="prenom.nom@papernest.com">
            </div>

            <div class="groupe-champ">
                <label>üîí Mot de passe</label>
                <input type="password" id="pass-signup" placeholder="Minimum 8 caract√®res">
            </div>

            <div class="groupe-champ">
                <label>üîí Confirmer</label>
                <input type="password" id="pass-confirm" placeholder="Retapez le mot de passe">
            </div>

            <button class="btn-connexion" id="btn-signup" onclick="inscription()">
                Cr√©er mon compte
            </button>

            <div class="lien-switch">
                <a href="#" onclick="afficherConnexion(); return false;">‚Üê Retour √† la connexion</a>
            </div>

            <div class="message-erreur" id="erreur-signup"></div>
        </div>

        <div class="login-equipes">
            üá≥üá¥ üá´üá∑ üá®üá¶ üá¶üáπ üá∫üá∏
        </div>
    </div>

    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const sb = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.KEY);

        function afficherInscription() {
            document.getElementById('zone-connexion').style.display = 'none';
            document.getElementById('zone-inscription').style.display = 'block';
            // Reset des erreurs
            document.getElementById('erreur-signup').classList.remove('visible');
        }

        function afficherConnexion() {
            document.getElementById('zone-connexion').style.display = 'block';
            document.getElementById('zone-inscription').style.display = 'none';
            document.getElementById('erreur-login').classList.remove('visible');
        }

        async function connexion() {
            const email = document.getElementById('email-login').value.trim();
            const password = document.getElementById('pass-login').value;

            if (!email || !password) {
                afficherErreur('erreur-login', 'Remplissez tous les champs');
                return;
            }

            const btn = document.getElementById('btn-login');
            btn.textContent = 'Connexion...';
            btn.disabled = true;

            try {
                // 1. Connexion Auth
                const result = await sb.auth.signInWithPassword({ email, password });
                if (result.error) throw result.error;

                // 2. V√©rification Profil
                const user = await sb.from('users').select('*').eq('id', result.data.user.id).single();

                if (!user.data || !user.data.onboarding_complete) {
                    window.location.href = 'onboarding.html';
                } else if (user.data.role === 'manager' || user.data.role === 'admin') {
                    window.location.href = 'manager.html';
                } else {
                    window.location.href = 'dashboard.html';
                }

            } catch (error) {
                afficherErreur('erreur-login', "Erreur : " + error.message);
                btn.textContent = 'Se Connecter ‚Üí';
                btn.disabled = false;
            }
        }

        async function inscription() {
            // 1. R√©cup√©ration des valeurs
            const prenom = document.getElementById('prenom-signup').value.trim();
            const nom = document.getElementById('nom-signup').value.trim();
            const email = document.getElementById('email-signup').value.trim();
            const password = document.getElementById('pass-signup').value;
            const confirm = document.getElementById('pass-confirm').value;

            // 2. V√©rifications de base
            if (!prenom || !nom || !email || !password || !confirm) {
                afficherErreur('erreur-signup', 'Merci de remplir tous les champs !');
                return;
            }
            if (!email.endsWith('@papernest.com')) {
                afficherErreur('erreur-signup', 'L\'email doit finir par @papernest.com');
                return;
            }
            if (password.length < 6) {
                afficherErreur('erreur-signup', 'Mot de passe trop court (min 6)');
                return;
            }
            if (password !== confirm) {
                afficherErreur('erreur-signup', 'Les mots de passe ne correspondent pas');
                return;
            }

            const btn = document.getElementById('btn-signup');
            btn.textContent = 'Cr√©ation en cours...';
            btn.disabled = true;

            try {
                // --- √âTAPE A : Cr√©er l'acc√®s Auth ---
                const { data: authData, error: authError } = await sb.auth.signUp({ 
                    email, 
                    password,
                    options: { data: { prenom: prenom, nom: nom } }
                });

                if (authError) throw authError;
                
                // Si l'utilisateur existe d√©j√†
                if (authData?.user?.identities?.length === 0) {
                     throw new Error("Cet email est d√©j√† utilis√©.");
                }

                console.log("‚úÖ Auth cr√©√© :", authData.user.id);

                // --- √âTAPE B : Cr√©er la fiche dans la table 'users' ---
                const { error: insertError } = await sb.from('users').insert({
                    id: authData.user.id, // ID venant de l'Auth
                    email: email,
                    prenom: prenom,
                    nom: nom,
                    role: 'agent',
                    equipe_id: 1, // On force l'√©quipe 1 pour d√©marrer
                    cellule: 'P√©pini√®re', // On force une cellule par d√©faut
                    onboarding_complete: false
                });

                if (insertError) {
                    console.error("‚ùå ERREUR INSERTION DB :", insertError);
                    alert("ERREUR CRITIQUE !\n\nL'authentification a march√©, mais l'enregistrement dans la base de donn√©es a √©chou√©.\n\nMessage : " + insertError.message + "\nCode : " + insertError.code);
                    throw insertError;
                }

                // Succ√®s total
                console.log("‚úÖ Profil DB cr√©√© avec succ√®s !");
                alert("üéâ Compte cr√©√© avec succ√®s ! Redirection...");
                window.location.href = 'onboarding.html';

            } catch (error) {
                console.error(error);
                afficherErreur('erreur-signup', error.message || "Erreur inconnue");
                btn.textContent = 'Cr√©er mon compte';
                btn.disabled = false;
            }
        }

             

        function afficherErreur(id, texte) {
            const elem = document.getElementById(id);
            elem.textContent = texte;
            elem.classList.add('visible');
        }
    </script>
</body>
</html>