<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéø JO d'Hiver ‚Äî Connexion</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1565C0 0%, #1976D2 100%);
            min-height: 100vh; /* Permet √† la page de grandir */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px; /* Marge pour ne pas coller aux bords */
            overflow-y: auto; /* ‚úÖ SCROLL AUTORIS√â */
        }

        /* Animation Neige */
        .neige-particule {
            position: absolute; width: 10px; height: 10px; background: white;
            border-radius: 50%; opacity: 0.7; animation: neige 10s linear infinite;
            pointer-events: none; /* La neige ne bloque pas les clics */
        }
        .neige-particule:nth-child(1) { left: 10%; animation-delay: 0s; }
        .neige-particule:nth-child(2) { left: 30%; animation-delay: 2s; }
        .neige-particule:nth-child(3) { left: 50%; animation-delay: 4s; }
        .neige-particule:nth-child(4) { left: 70%; animation-delay: 1s; }
        .neige-particule:nth-child(5) { left: 90%; animation-delay: 3s; }
        @keyframes neige { 0% { top: -10%; } 100% { top: 110%; } }
        
        .login-carte {
            background: white; padding: 40px; border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2); 
            width: 100%; max-width: 420px; 
            z-index: 10;
            margin: auto; /* Centrage */
        }
        
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-titre { color: #1565C0; font-size: 28px; margin-bottom: 8px; }
        .login-sous-titre { color: #757575; font-size: 14px; }
        .login-separateur { height: 2px; background: linear-gradient(to right, transparent, #E0E0E0, transparent); margin-bottom: 30px; }
        
        .groupe-champ { margin-bottom: 20px; }
        .groupe-champ label { display: block; color: #424242; font-size: 14px; font-weight: 600; margin-bottom: 8px; }
        .groupe-champ input { width: 100%; padding: 12px 16px; border: 2px solid #E0E0E0; border-radius: 8px; font-size: 15px; transition: border-color 0.2s; }
        .groupe-champ input:focus { outline: none; border-color: #1976D2; }
        
        .btn-connexion {
            width: 100%; padding: 14px; background: #1976D2; color: white; border: none;
            border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s;
        }
        .btn-connexion:hover { background: #1565C0; }
        .btn-connexion:disabled { background: #BDBDBD; cursor: not-allowed; }
        
        .message-erreur {
            background: #FFEBEE; color: #C62828; padding: 12px; border-radius: 8px;
            margin-top: 16px; display: none; font-size: 14px;
        }
        .message-erreur.visible { display: block; }
        
        .lien-switch { text-align: center; margin-top: 16px; }
        .lien-switch a { color: #1976D2; text-decoration: none; font-size: 14px; font-weight: 600; }
        .lien-switch a:hover { text-decoration: underline; }
        
        h3 { text-align: center; color: #1565C0; margin-bottom: 24px; }
        .ligne-double { display: flex; gap: 10px; }
        .login-equipes { text-align: center; margin-top: 24px; font-size: 24px; letter-spacing: 8px; }
    </style>
</head>
<body>
    <div class="neige-particule"></div>
    <div class="neige-particule"></div>
    <div class="neige-particule"></div>

    <div class="login-carte">
        <div class="login-header">
            <img src="assets/olympic.png" alt="Logo" style="height: 80px; margin-bottom: 20px;">
            <h1 class="login-titre">JO d'Hiver 2026</h1>
            <p class="login-sous-titre">Challenge Commercial ‚Äî Call Center</p>
        </div>

        <div class="login-separateur"></div>

        <div id="zone-connexion">
            <h3>Connexion</h3>
            <div class="groupe-champ">
                <label>üìß Email</label>
                <input type="email" id="email-login" placeholder="prenom.nom@papernest.com">
            </div>
            <div class="groupe-champ">
                <label>üîí Mot de passe</label>
                <input type="password" id="pass-login" placeholder="Votre mot de passe">
            </div>
            <button class="btn-connexion" id="btn-login" onclick="connexion()">Se Connecter ‚Üí</button>
            <div class="lien-switch">
                <a href="#" onclick="afficherInscription(); return false;">Premi√®re connexion ? Cr√©er un compte</a>
            </div>
            <div class="message-erreur" id="erreur-login"></div>
        </div>

        <div id="zone-inscription" style="display: none;">
            <h3>Cr√©er mon compte</h3>
            <div class="ligne-double">
                <div class="groupe-champ">
                    <label>üë§ Pr√©nom</label>
                    <input type="text" id="prenom-signup" placeholder="Ex: Thomas">
                </div>
                <div class="groupe-champ">
                    <label>üë§ Nom</label>
                    <input type="text" id="nom-signup" placeholder="Ex: Durand">
                </div>
            </div>
            <div class="groupe-champ">
                <label>üìß Email</label>
                <input type="email" id="email-signup" placeholder="prenom.nom@papernest.com">
            </div>
            <div class="groupe-champ">
                <label>üîí Mot de passe</label>
                <input type="password" id="pass-signup" placeholder="Minimum 6 caract√®res">
            </div>
            <div class="groupe-champ">
                <label>üîí Confirmer</label>
                <input type="password" id="pass-confirm" placeholder="Retapez le mot de passe">
            </div>
            <button class="btn-connexion" id="btn-signup" onclick="inscription()">Cr√©er mon compte</button>
            <div class="lien-switch">
                <a href="#" onclick="afficherConnexion(); return false;">‚Üê Retour √† la connexion</a>
            </div>
            <div class="message-erreur" id="erreur-signup"></div>
        </div>

        <div class="login-equipes">üá≥üá¥ üá´üá∑ üá®üá¶ üá¶üáπ üá∫üá∏</div>
    </div>

    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 1. Initialisation Supabase
        const sb = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.KEY);

        // 2. Fonctions d'interface
        function afficherInscription() {
            document.getElementById('zone-connexion').style.display = 'none';
            document.getElementById('zone-inscription').style.display = 'block';
            document.getElementById('erreur-signup').classList.remove('visible');
        }

        function afficherConnexion() {
            document.getElementById('zone-connexion').style.display = 'block';
            document.getElementById('zone-inscription').style.display = 'none';
            document.getElementById('erreur-login').classList.remove('visible');
        }

        function afficherErreur(id, texte) {
            const elem = document.getElementById(id);
            elem.textContent = texte;
            elem.classList.add('visible');
        }

        // 3. Logique de Connexion
        async function connexion() {
            const email = document.getElementById('email-login').value.trim();
            const password = document.getElementById('pass-login').value;

            if (!email || !password) {
                afficherErreur('erreur-login', 'Merci de remplir tous les champs.');
                return;
            }

            const btn = document.getElementById('btn-login');
            btn.textContent = 'Connexion...';
            btn.disabled = true;

            try {
                const { data, error } = await sb.auth.signInWithPassword({ email, password });
                if (error) throw error;

                // R√©cup√©rer le r√¥le pour rediriger
                const { data: userData } = await sb.from('users').select('role').eq('id', data.user.id).single();
                
                // Redirection intelligente
                if (userData && userData.role === 'admin') window.location.href = 'plateau.html';
                else if (userData && userData.role === 'manager') window.location.href = 'manager.html';
                else window.location.href = 'dashboard.html';

            } catch (error) {
                console.error(error);
                afficherErreur('erreur-login', "Erreur : Email ou mot de passe incorrect.");
                btn.textContent = 'Se Connecter ‚Üí';
                btn.disabled = false;
            }
        }

        // 4. Logique d'Inscription
        async function inscription() {
            const prenom = document.getElementById('prenom-signup').value.trim();
            const nom = document.getElementById('nom-signup').value.trim();
            const email = document.getElementById('email-signup').value.trim();
            const password = document.getElementById('pass-signup').value;
            const confirm = document.getElementById('pass-confirm').value;

            if (!prenom || !nom || !email || !password || !confirm) {
                afficherErreur('erreur-signup', 'Merci de remplir tous les champs !');
                return;
            }
            if (!email.endsWith('@papernest.com')) {
                afficherErreur('erreur-signup', 'Utilisez votre email @papernest.com');
                return;
            }
            if (password.length < 6) {
                afficherErreur('erreur-signup', 'Le mot de passe doit faire 6 caract√®res min.');
                return;
            }
            if (password !== confirm) {
                afficherErreur('erreur-signup', 'Les mots de passe ne correspondent pas.');
                return;
            }

            const btn = document.getElementById('btn-signup');
            btn.textContent = 'Cr√©ation...';
            btn.disabled = true;

            try {
                // A. Cr√©ation compte Auth
                const { data: authData, error: authError } = await sb.auth.signUp({ 
                    email, 
                    password,
                    options: { data: { prenom, nom } }
                });

                if (authError) throw authError;
                if (authData?.user?.identities?.length === 0) throw new Error("Cet email est d√©j√† utilis√©. Essayez de vous connecter.");

                // B. Cr√©ation profil User
                const { error: insertError } = await sb.from('users').insert({
                    id: authData.user.id,
                    email: email,
                    prenom: prenom,
                    nom: nom,
                    role: 'agent',
                    equipe_id: null, 
                    cellule: 'P√©pini√®re', 
                    onboarding_complete: false
                });

                if (insertError) throw insertError;

                alert("üéâ Compte cr√©√© avec succ√®s ! Bienvenue !");
                window.location.href = 'dashboard.html';

            } catch (error) {
                console.error(error);
                let message = error.message;
                if(message.includes("User already registered")) message = "Cet email est d√©j√† inscrit ! Connectez-vous.";
                
                afficherErreur('erreur-signup', message);
                btn.textContent = 'Cr√©er mon compte';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>