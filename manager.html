<!DOCTYPE html>
<!--
    =============================================================
    FICHIER : manager.html
    PROJET  : JO d'Hiver ‚Äî Dashboard Commercial
    PAGE    : Dashboard Manager (vue √©quipe)
    =============================================================
-->

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>üëî Dashboard Manager ‚Äî JO d'Hiver</title>

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="manager.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Biblioth√®ques essentielles -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<!-- =============================================================
     MODAL CR√âATION CHALLENGE FLASH
     √Ä ajouter dans manager.html juste avant </body>
     ============================================================= -->

<!-- Modal Cr√©ation Challenge -->
<div class="modal" id="modal-challenge">
    <div class="modal-overlay" onclick="fermerModalChallenge()"></div>
    <div class="modal-contenu">
        <div class="modal-header">
            <h2>‚ö° Cr√©er un Challenge Flash</h2>
            <button class="modal-close" onclick="fermerModalChallenge()">√ó</button>
        </div>
        
        <form id="form-challenge" onsubmit="creerChallenge(event)">
            <div class="form-group">
                <label>üéØ Titre du challenge</label>
                <input type="text" id="challenge-titre" placeholder="Ex: Sprint du Matin" required>
            </div>

            <div class="form-group">
                <label>üìù Description</label>
                <textarea id="challenge-description" rows="3" placeholder="Ex: Validez 3 contrats entre 9h et 12h" required></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>üèÅ Type de challenge</label>
                    <select id="challenge-type" required>
                        <option value="">-- Choisir --</option>
                        <option value="Nombre de contrats">Nombre de contrats</option>
                        <option value="Premier √† X contrats">Premier √† X contrats</option>
                        <option value="Contrats dans un d√©lai">Contrats dans un d√©lai</option>
                        <option value="ApiApp uniquement">ApiApp uniquement</option>
                        <option value="Type de contrat sp√©cifique">Type de contrat sp√©cifique</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üéÅ Points bonus</label>
                    <input type="number" id="challenge-points" min="10" max="500" value="50" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>üìÖ Date et heure de d√©but</label>
                    <input type="datetime-local" id="challenge-debut" required>
                </div>

                <div class="form-group">
                    <label>üìÖ Date et heure de fin</label>
                    <input type="datetime-local" id="challenge-fin" required>
                </div>
            </div>

            <div class="form-group">
                <label>üéØ Objectif (nombre)</label>
                <input type="number" id="challenge-objectif" min="1" max="50" value="3" placeholder="Ex: 3 contrats">
                <small>Nombre de contrats √† atteindre pour gagner</small>
            </div>

            <div class="form-group">
                <label>üë• Cible</label>
                <select id="challenge-cible" required>
                    <option value="tous">Tous les agents</option>
                    <option value="equipe">Mon √©quipe uniquement</option>
                    <option value="cellule">Une cellule sp√©cifique</option>
                </select>
            </div>

            <div class="form-group" id="groupe-cellule" style="display: none;">
                <label>üìä Cellule concern√©e</label>
                <select id="challenge-cellule">
                    <option value="">-- Toutes --</option>
                    <option value="Mover">Mover</option>
                    <option value="Switcher">Switcher</option>
                    <option value="Coach">Coach</option>
                    <option value="P√©pini√®re">P√©pini√®re</option>
                </select>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="fermerModalChallenge()">Annuler</button>
                <button type="submit" class="btn-primary" id="btn-creer-challenge">‚úÖ Cr√©er le Challenge</button>
            </div>

            <div class="message-succes" id="message-challenge-succes"></div>
            <div class="message-erreur" id="message-challenge-erreur"></div>
        </form>
    </div>
</div>

<!-- Styles pour le modal -->
<style>
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.modal.actif {
    display: flex;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.modal-contenu {
    position: relative;
    background: white;
    padding: 32px;
    border-radius: 16px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #E0E0E0;
}

.modal-header h2 {
    margin: 0;
    color: #1565C0;
    font-size: 24px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 32px;
    color: #757575;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    line-height: 1;
}

.modal-close:hover {
    color: #C62828;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 600;
    color: #424242;
    margin-bottom: 8px;
    font-size: 14px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #E0E0E0;
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #1976D2;
}

.form-group small {
    display: block;
    margin-top: 4px;
    color: #757575;
    font-size: 12px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 2px solid #E0E0E0;
}

.modal-actions button {
    flex: 1;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: #1976D2;
    color: white;
}

.btn-primary:hover {
    background: #1565C0;
}

.btn-secondary {
    background: #E0E0E0;
    color: #424242;
}

.btn-secondary:hover {
    background: #BDBDBD;
}

.message-succes,
.message-erreur {
    display: none;
    padding: 12px;
    border-radius: 8px;
    margin-top: 16px;
    font-size: 14px;
}

.message-succes {
    background: #E8F5E9;
    color: #2E7D32;
    border: 1px solid #4CAF50;
}

.message-erreur {
    background: #FFEBEE;
    color: #C62828;
    border: 1px solid #F44336;
}
</style>

<!-- Script pour g√©rer le modal -->
<script>
(function() {
    // R√©cup√©rer le client Supabase
    const supabase = window.supabaseClient || window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.KEY);

    // Fonctions export√©es vers window pour √™tre accessibles depuis le HTML
    window.ouvrirModalChallenge = function() {
        document.getElementById('modal-challenge').classList.add('actif');
        
        const maintenant = new Date();
        const dans1h = new Date(maintenant.getTime() + 60 * 60 * 1000);
        
        document.getElementById('challenge-debut').value = maintenant.toISOString().slice(0, 16);
        document.getElementById('challenge-fin').value = dans1h.toISOString().slice(0, 16);
    };

    window.fermerModalChallenge = function() {
        document.getElementById('modal-challenge').classList.remove('actif');
        document.getElementById('form-challenge').reset();
        document.getElementById('message-challenge-succes').style.display = 'none';
        document.getElementById('message-challenge-erreur').style.display = 'none';
    };

    window.creerChallenge = async function(event) {
        event.preventDefault();
        
        const btn = document.getElementById('btn-creer-challenge');
        btn.disabled = true;
        btn.textContent = '‚è≥ Cr√©ation...';
        
        try {
            const titre = document.getElementById('challenge-titre').value;
            const description = document.getElementById('challenge-description').value;
            const type = document.getElementById('challenge-type').value;
            const points = parseInt(document.getElementById('challenge-points').value);
            const dateDebut = document.getElementById('challenge-debut').value;
            const dateFin = document.getElementById('challenge-fin').value;
            const objectif = parseInt(document.getElementById('challenge-objectif').value);
            const cible = document.getElementById('challenge-cible').value;
            const cellule = document.getElementById('challenge-cellule').value;
            
            if (new Date(dateDebut) >= new Date(dateFin)) {
                throw new Error('La date de fin doit √™tre apr√®s la date de d√©but');
            }
            
            const { data, error } = await supabase
                .from('challenges_flash')
                .insert({
                    titre: titre,
                    description: description,
                    type_challenge: type,
                    date_debut: dateDebut,
                    date_fin: dateFin,
                    points_attribues: points,
                    objectif: objectif,
                    cible: cible,
                    cellule_cible: cible === 'cellule' ? cellule : null,
                    equipe_id: cible === 'equipe' ? window.managerActuel?.equipe_id : null,
                    createur_id: window.managerActuel?.id,
                    statut: 'actif'
                })
                .select();
            
            if (error) throw error;
            
            const msgSucces = document.getElementById('message-challenge-succes');
            msgSucces.textContent = '‚úÖ Challenge cr√©√© avec succ√®s !';
            msgSucces.style.display = 'block';
            
            setTimeout(() => {
                window.fermerModalChallenge();
                if (typeof chargerChallengesActifs === 'function') {
                    chargerChallengesActifs();
                }
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Erreur cr√©ation challenge:', error);
            const msgErreur = document.getElementById('message-challenge-erreur');
            msgErreur.textContent = '‚ùå Erreur : ' + error.message;
            msgErreur.style.display = 'block';
            
            btn.disabled = false;
            btn.textContent = '‚úÖ Cr√©er le Challenge';
        }
    };

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        const cibleSelect = document.getElementById('challenge-cible');
        if (cibleSelect) {
            cibleSelect.addEventListener('change', function() {
                const groupeCellule = document.getElementById('groupe-cellule');
                if (groupeCellule) groupeCellule.style.display = this.value === 'cellule' ? 'block' : 'none';
            });
        }

        setTimeout(() => {
            const m = window.managerActuel;
            if (m && (m.role === 'manager' || m.role === 'admin')) {
                const btnCreer = document.getElementById('btn-creer-challenge');
                if (btnCreer) {
                    btnCreer.addEventListener('click', window.ouvrirModalChallenge);
                }
            }
        }, 1000);
    });
})();
</script>
<body class="manager-body">

    <!-- =============================================================
         HEADER MANAGER
         ============================================================= -->
    <header class="manager-header">
        <div class="header-container">
            
            <!-- Logo -->
            <div class="header-logo">
                <span class="logo-icon">üèîÔ∏è</span>
                <div class="logo-text">
                    <h1>JO d'Hiver 2026</h1>
                    <p>Dashboard Manager</p>
                </div>
            </div>

            <!-- Info Manager -->
            <div class="header-manager">
                <div class="manager-avatar">
                    <img src="https://ui-avatars.com/api/?name=Sophie+Martin&background=002395&color=fff&size=80" 
                         alt="Avatar" id="avatar-manager">
                </div>
                <div class="manager-info">
                    <h2 id="nom-manager">Sophie Martin</h2>
                    <p id="equipe-manager">Manager ‚Äî √âquipe France üá´üá∑</p>
                </div>
                <div class="manager-stats">
                    <div class="stat-equipe">
                        <span class="stat-valeur" id="score-equipe">1,247</span>
                        <span class="stat-label">pts √©quipe</span>
                    </div>
                </div>
                <div class="header-actions">
                    <!-- NOUVEAU : Bouton Vue Plateau -->
                    <button class="btn-vue-plateau" id="btn-vue-plateau" title="Voir les classements globaux">
                        üìä Vue Plateau
                    </button>

                    <!-- NOUVEAU : Menu d√©roulant √âquipes (uniquement pour admins) -->
                    <div class="dropdown-equipes" id="dropdown-equipes" style="display: none;">
                        <button class="btn-changer-equipe" id="btn-changer-equipe">
                            Changer √©quipe ‚ñº
                        </button>
                        <div class="dropdown-menu" id="menu-equipes">
                            <!-- Rempli dynamiquement par JS -->
                        </div>
                    </div>

                    <button class="btn-notif" id="btn-notifications">
                        üîî
                        <span class="notif-badge" id="notif-count">3</span>
                    </button>
                    <button class="btn-deconnexion" id="btn-deconnexion">
                        üö™ D√©connexion
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- =============================================================
         CONTENU PRINCIPAL
         ============================================================= -->
    <main class="manager-main">
        <div class="manager-container">

            <!-- SECTION VALIDATION CONTRATS (Priorit√© haute) -->
            <section class="section-validation">
                <div class="section-header">
                    <h2 class="section-titre">‚ö†Ô∏è Contrats en attente de validation</h2>
                    <span class="badge-count" id="contrats-attente-count">3</span>
                </div>

                <!-- Liste des contrats en attente -->
                <div class="contrats-validation-liste" id="contrats-validation-liste">
                    <!-- Charg√©s dynamiquement par JS -->
                    <div class="contrat-validation-item">
                        <div class="contrat-validation-info">
                            <div class="contrat-type-badge">üìû Telco</div>
                            <div class="contrat-details">
                                <div class="contrat-agent">Gerald Mercier (Mover)</div>
                                <div class="contrat-date">Aujourd'hui √† 14:32</div>
                            </div>
                        </div>
                        <div class="contrat-validation-actions">
                            <button class="btn-lien" onclick="ouvrirLien('https://salesforce.com/12345')">
                                üîó Voir piste
                            </button>
                            <button class="btn-valider" onclick="validerContrat('c1')">
                                ‚úÖ Valider
                            </button>
                            <button class="btn-rejeter" onclick="rejeterContrat('c1')">
                                ‚ùå Rejeter
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Message si aucun contrat -->
                <div class="aucun-contrat" id="aucun-contrat" style="display: none;">
                    ‚úÖ Tous les contrats sont valid√©s ! Excellent travail.
                </div>
            </section>

            <!-- STATISTIQUES √âQUIPE -->
            <section class="section-stats">
                <div class="stats-grid">
                    
                    <!-- Position √©quipe -->
                    <div class="stat-carte">
                        <div class="stat-icone">üèÜ</div>
                        <div class="stat-contenu">
                            <div class="stat-label">Position</div>
                            <div class="stat-valeur" id="position-equipe">2√®me</div>
                            <div class="stat-detail">sur 5 √©quipes</div>
                        </div>
                    </div>

                    <!-- Agents actifs -->
                    <div class="stat-carte">
                        <div class="stat-icone">üë•</div>
                        <div class="stat-contenu">
                            <div class="stat-label">Agents</div>
                            <div class="stat-valeur" id="agents-actifs">10/10</div>
                            <div class="stat-detail">actifs</div>
                        </div>
                    </div>

                    <!-- Moyenne -->
                    <div class="stat-carte">
                        <div class="stat-icone">üìä</div>
                        <div class="stat-contenu">
                            <div class="stat-label">Moyenne</div>
                            <div class="stat-valeur" id="score-moyen">124.7</div>
                            <div class="stat-detail">pts par agent</div>
                        </div>
                    </div>

                    <!-- Contrats valid√©s -->
                    <div class="stat-carte">
                        <div class="stat-icone">‚úÖ</div>
                        <div class="stat-contenu">
                            <div class="stat-label">Contrats</div>
                            <div class="stat-valeur" id="contrats-valides">127</div>
                            <div class="stat-detail">valid√©s</div>
                        </div>
                    </div>

                </div>
            </section>

            <!-- PERFORMANCE PAR CELLULE -->
            <section class="section-cellules">
                <h2 class="section-titre">üìä Performance par Cellule</h2>
                
                <div class="cellules-grid" id="cellules-grid">
                    <!-- Charg√©es dynamiquement par JS -->
                </div>
            </section>

            <!-- TABLEAU D√âTAILL√â DES AGENTS -->
            <section class="section-agents">
                <div class="section-header">
                    <h2 class="section-titre">üìã Tous les Agents de l'√âquipe</h2>
                    <div class="section-actions">
                        <select id="filtre-cellule" class="filtre-select">
                            <option value="">Toutes les cellules</option>
                            <option value="Mover">Movers</option>
                            <option value="Switcher">Switchers</option>
                            <option value="Coach">Coachs</option>
                            <option value="P√©pini√®re">P√©pini√®re</option>
                        </select>
                        <button class="btn-export" onclick="exporterCSV()">
                            üì• Exporter CSV
                        </button>
                    </div>
                </div>

                <!-- Tableau -->
                <div class="tableau-container">
                    <table class="tableau-agents" id="tableau-agents">
                        <thead>
                            <tr>
                                <th onclick="trierTableau('nom')">Agent</th>
                                <th onclick="trierTableau('cellule')">Cellule</th>
                                <th onclick="trierTableau('score')">Score</th>
                                <th onclick="trierTableau('global')">Rang Global</th>
                                <th onclick="trierTableau('equipe')">Rang √âquipe</th>
                                <th onclick="trierTableau('cellule-rang')">Rang Cellule</th>
                                <th>Contrats</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableau-agents-body">
                            <!-- Charg√© dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- CALENDRIER √âQUIPE -->
            <section class="section-calendrier">
                <h2 class="section-titre">üìÖ Performance Quotidienne de l'√âquipe</h2>
                <div class="calendrier-equipe-grid" id="calendrier-equipe-grid">
                    <!-- Charg√© dynamiquement -->
                </div>
            </section>

            <!-- ACTIONS RAPIDES -->
            <section class="section-actions-rapides">
                <h2 class="section-titre">‚ö° Actions Rapides</h2>
                <div class="actions-grid">
                    <button class="action-btn" onclick="ouvrirModalPoints()">
                        <span class="action-icone">‚ûï</span>
                        <span class="action-texte">Attribuer Points Bonus</span>
                    </button>
                    <button class="action-btn" onclick="ouvrirModalBadge()">
                        <span class="action-icone">üèÖ</span>
                        <span class="action-texte">D√©bloquer un Badge</span>
                    </button>
                    <button class="action-btn" onclick="genererRapport()">
                        <span class="action-icone">üìä</span>
                        <span class="action-texte">Rapport D√©taill√©</span>
                    </button>
                    <button class="action-btn" onclick="envoyerNotification()">
                        <span class="action-icone">üì¢</span>
                        <span class="action-texte">Notification √âquipe</span>
                    </button>
                </div>
            </section>

        </div>
    </main>

    <!-- =============================================================
         MODALS
         ============================================================= -->

    <!-- Modal Attribution Points -->
    <div class="modal" id="modal-points">
        <div class="modal-overlay" onclick="fermerModal('modal-points')"></div>
        <div class="modal-contenu">
            <h3>‚ûï Attribuer des Points Bonus</h3>
            <form id="form-points" onsubmit="return soumettrePoints(event)">
                <div class="form-groupe">
                    <label>Agent :</label>
                    <select id="select-agent-points" required>
                        <option value="">-- S√©lectionner un agent --</option>
                    </select>
                </div>
                <div class="form-groupe">
                    <label>Points (positif ou n√©gatif) :</label>
                    <input type="number" id="input-points" placeholder="Ex: 10 ou -5" required>
                </div>
                <div class="form-groupe">
                    <label>Raison :</label>
                    <textarea id="textarea-raison" rows="3" placeholder="Expliquez la raison..." required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="fermerModal('modal-points')">Annuler</button>
                    <button type="submit" class="btn-primary">Confirmer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Badge -->
    <div class="modal" id="modal-badge">
        <div class="modal-overlay" onclick="fermerModal('modal-badge')"></div>
        <div class="modal-contenu">
            <h3>üèÖ D√©bloquer un Badge</h3>
            <form id="form-badge" onsubmit="return soumettreBadge(event)">
                <div class="form-groupe">
                    <label>Agent :</label>
                    <select id="select-agent-badge" required>
                        <option value="">-- S√©lectionner un agent --</option>
                    </select>
                </div>
                <div class="form-groupe">
                    <label>Badge :</label>
                    <select id="select-badge" required>
                        <option value="">-- S√©lectionner un badge --</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="fermerModal('modal-badge')">Annuler</button>
                    <button type="submit" class="btn-primary">D√©bloquer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- =============================================================
         SCRIPTS
         ============================================================= -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="manager.js"></script>

</body>
</html>
