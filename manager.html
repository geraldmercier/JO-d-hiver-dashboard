<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëî Dashboard Manager ‚Äî JO d'Hiver</title>
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="manager.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body class="manager-body">

    <header class="manager-header">
        <div class="header-container">
            <div class="header-logo">
                <span class="logo-icon">üèîÔ∏è</span>
                <div class="logo-text">
                    <h1>JO d'Hiver 2026</h1>
                    <p>Dashboard Manager</p>
                </div>
            </div>

            <div class="header-manager">
                <div class="manager-avatar">
                    <img src="" alt="Avatar" id="avatar-manager">
                </div>
                <div class="manager-info">
                    <h2 id="nom-manager">Chargement...</h2>
                    <p id="equipe-manager">Chargement...</p>
                </div>
                <div class="manager-stats">
                    <div class="stat-equipe">
                        <span class="stat-valeur" id="score-equipe-total">0</span>
                        <span class="stat-label">pts √©quipe</span>
                    </div>
                </div>
                <div class="header-actions">
                    <a href="plateau.html" class="btn-vue-plateau" style="text-decoration: none;">üìä Vue Plateau</a>

                    <div class="dropdown-equipes" id="dropdown-equipes-admin" style="display: none;">
                        <button class="btn-changer-equipe">Changer √©quipe ‚ñº</button>
                        <div class="dropdown-menu" id="menu-equipes-admin"></div>
                    </div>

                    <a href="index.html" class="btn-deconnexion" style="text-decoration: none;">üö™ D√©connexion</a>
                </div>
            </div>
        </div>
    </header>

    <main class="manager-main">
        <div class="manager-container">

            <section class="section-validation">
                <div class="section-header">
                    <h2 class="section-titre">‚ö†Ô∏è Contrats en attente</h2>
                    <span class="badge-count" id="badge-attente" style="display:none">0</span>
                </div>
                <div class="contrats-validation-liste" id="contrats-attente-liste">
                    <div class="chargement">Chargement des contrats...</div>
                </div>
            </section>

            <section class="section-stats">
                <div class="stats-grid">
                    <div class="stat-carte">
                        <div class="stat-icone">üèÜ</div>
                        <div class="stat-contenu">
                            <div class="stat-label">Position</div>
                            <div class="stat-valeur" id="position-equipe">-</div>
                        </div>
                    </div>
                    <div class="stat-carte">
                        <div class="stat-icone">‚úÖ</div>
                        <div class="stat-contenu">
                            <div class="stat-label">Contrats</div>
                            <div class="stat-valeur" id="contrats-valides">0</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section-agents">
                <div class="section-header">
                    <h2 class="section-titre">üìã Agents de l'√âquipe</h2>
                </div>
                <div class="tableau-container">
                    <table class="tableau-agents" id="tableau-agents">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Agent</th>
                                <th>Cellule</th>
                                <th>Score</th>
                                <th>Contrats</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableau-agents-body"></tbody>
                    </table>
                </div>
            </section>

            <section class="section-actions-rapides">
                <h2 class="section-titre">‚ö° Actions Rapides</h2>
                <div class="actions-grid">
                    <button class="action-btn" onclick="ouvrirModalChallenge()">
                        <span class="action-icone">‚ö°</span>
                        <span class="action-texte">Cr√©er un Challenge Flash</span>
                    </button>
                </div>
            </section>

        </div>
    </main>

    <div class="modal" id="modal-challenge" style="display:none;">
        <div class="modal-overlay" onclick="fermerModalChallenge()"></div>
        <div class="modal-contenu">
            <div class="modal-header">
                <h2>‚ö° Cr√©er un Challenge</h2>
                <button class="modal-close" onclick="fermerModalChallenge()">√ó</button>
            </div>
            <form id="form-challenge" onsubmit="creerChallenge(event)">
                <div class="form-group">
                    <label>Titre</label>
                    <input type="text" id="challenge-titre" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="challenge-description" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Points</label>
                        <input type="number" id="challenge-points" value="50">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="challenge-type">
                            <option value="Nombre de contrats">Volume</option>
                            <option value="Premier √† X contrats">Course</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>D√©but</label>
                        <input type="datetime-local" id="challenge-debut" required>
                    </div>
                    <div class="form-group">
                        <label>Fin</label>
                        <input type="datetime-local" id="challenge-fin" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Cible</label>
                    <select id="challenge-cible">
                        <option value="tous">Tous</option>
                        <option value="equipe">Mon √©quipe</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="fermerModalChallenge()">Annuler</button>
                    <button type="submit" class="btn-primary" id="btn-submit-challenge">Cr√©er</button>
                </div>
                <div id="message-challenge-succes" class="message-succes"></div>
            </form>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="manager.js"></script>

    <script>
        window.ouvrirModalChallenge = function() {
            document.getElementById('modal-challenge').style.display = 'flex';
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('challenge-debut').value = now.toISOString().slice(0,16);
        };
        window.fermerModalChallenge = function() {
            document.getElementById('modal-challenge').style.display = 'none';
        };
        window.creerChallenge = async function(e) {
            e.preventDefault();
            // Ici on recr√©e une instance locale, c'est sans danger car c'est dans une fonction
            const sbLocal = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.KEY);
            const btn = document.getElementById('btn-submit-challenge');
            
            btn.disabled = true; btn.textContent = '...';
            try {
                const { error } = await sbLocal.from('challenges_flash').insert({
                    titre: document.getElementById('challenge-titre').value,
                    description: document.getElementById('challenge-description').value,
                    type_challenge: document.getElementById('challenge-type').value,
                    points_attribues: document.getElementById('challenge-points').value,
                    date_debut: document.getElementById('challenge-debut').value,
                    date_fin: document.getElementById('challenge-fin').value,
                    cible: document.getElementById('challenge-cible').value,
                    statut: 'actif'
                });
                if(error) throw error;
                document.getElementById('message-challenge-succes').textContent = '‚úÖ Cr√©√© !';
                setTimeout(() => { fermerModalChallenge(); document.getElementById('message-challenge-succes').textContent = ''; }, 1000);
            } catch(err) { alert(err.message); } 
            finally { btn.disabled = false; btn.textContent = 'Cr√©er'; }
        };
    </script>

</body>
</html>